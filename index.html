<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>周年</title>
    <meta name=description content="">
    <meta name=keywords content="">

    <script src="//cdn.bootcss.com/zepto/1.0rc1/zepto.min.js"></script>
    <script type="text/javascript" src="./static/lib/decomp.js"></script>
    <script type="text/javascript" src="./static/lib/pathseg.js"></script>
    <script src="./static/matter.js"></script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body{
            height: 100%;
        }

        body {
            background: #00011c url('./static/img/background.jpg') center / cover no-repeat;
            transform: translate3d(0, 0, 0);
        }

        .game-box canvas {
            margin: 0 auto;
            display: block;
        }

        .rank-block {
            position: fixed;
            //left: 900px;
            right: 100px;
            top: 0;
            bottom: 0;
            width: 265px;
        }

        .rank-label {
            border: 2px solid #d07000;
            border-radius: 5px;
            line-height: 40px;
            text-align: center;
            font-weight: bold;
            color: #f0c800;
            width: 160px;
            background: #d20804 linear-gradient(-45deg, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent);
            background-size: 40px 40px;
            position: absolute;
            top: 94px;
            left: 50px;
            font-size: 24px;
        }

        .rank-list {
            overflow: hidden;
        }

        .rank-list .item {
           // background: #003cff80;
           // border: 2px solid #f7ee26;
            border-radius: 10px;
            line-height: 30px;
            text-align: center;
            width: 30%;
            margin: 5px 1.5%;
            float: left;
            font-size: 16px;
            color: #f7ee26;
        }
    </style>
</head>

<body>
<div id="app-box">
    <div class="game-box" id="game-box"></div>

    <div class="rank-block">
        <image src="./static/img/rankTitle.png"/>
        <div class="rank-label" id="rankLabel">三等奖</div>

        <div class="rank-list" id="rankList">

        </div>
    </div>

    <div style="display: none">
        <img src="./static/img/ball1Texture.png" alt="">
        <img src="./static/img/ball2Texture.png" alt="">
        <img src="./static/img/ball3Texture.png" alt="">
        <img src="./static/img/ball4Texture.png" alt="">
    </div>
</div>
</body>
</html>


<script>

    let $rankLabel = $("#rankLabel");
    let $rankList = $("#rankList");

    let people = ["杨小航", "赵钺", "付贵森", "付强",
        "张西玲", "刘建", "徐辉", "马斌", "谷耀峰",
        "付佳炜", "张紫晨", "宋红京", "王隽", "李斌",
        "张志玉", "张锐", "崔屾", "李瑞娟", "周美景",
        "赵迅", "王文博", "刘啸", "胡春明", "张娜",
        "廖伟庆", "时春艳", "郭洁", "王泽岗", "于海洋",
        "张秀云", "张同乐", "金晓芳", "孙明", "张萌萌",
        "王迪", "王子轩", "曹东", "周启鑫", "林洲", "刘超",
        "张博", "余世祥", "白文", "王建志", "张少东", "焦彭通",
        "范治磊", "陈永廷", "刘鸿晶", "张涛", "卿卫文", "刘勇", "邹肖琳",
        "谢冰", "肖成伟", "李晓丹", "王诗尧", "赵贵全", "李克岩",
        "郑钢", "杨高", "刘先智", "赵博飞", "程都", "刘禹良",
        "段智夫", "孙鑫", "郁洋", "陶启森", "宋峰", "李泽国",
        "吕瑞雪", "池白露", "陶斯亮", "陈炎", "柴治田", "王敬峰",
        "杨金垚", "桑登科", "胡莎", "姜娣", "李秋晨", "童能能",
        "李丝雨", "王佩剑"];

    let gameStep = ~~localStorage.getItem("gameStep");
    let gameTimes = localStorage.getItem("gameTimes");
    let timeStamp = new Date().getTime();

    if(gameTimes !== null && gameTimes !== undefined){
    }else {
        gameTimes = 1;
    }

    //上次游戏结束则此次重新开始
    if (gameStep === 10) {
        gameStep = 0;
    }

    //上次没有正常结束
    if(gameStep !== 0){
        //获取 上一次的 游戏次数 和 游戏时间

        if(gameTimes === 0){
            gameTimes = 1;
        }

        console.log("============", gameTimes);

        let removeList = [];
        for(let i = 0; i < localStorage.length; i++){
            let key = localStorage.key(i);

            if(key.startsWith(`${gameTimes}_`)){
                timeStamp = key.split("_")[1];
                console.log('------------------',key, localStorage[key]);
                removeList = removeList.concat(localStorage.getItem(key).split(","));
            }
        }

        console.log(removeList, timeStamp);

        people = people.filter(item => {
            return !removeList.includes(item);
        });

        console.log(people.length);

        let type = "";
        if (gameStep <= 3) {
            $rankLabel.html("三等奖");
            type = "three";
        } else if (gameStep <= 7) {
            $rankLabel.html("二等奖");
            type = "two";
        } else if (gameStep <= 8) {
            $rankLabel.html("一等奖");
            type = "one";
        } else if (gameStep <= 10) {
            $rankLabel.html("特等奖");
            type = "super";
        }

        let storageKey = `${gameTimes}_${timeStamp}_${type}`;
        console.log(storageKey)
        let nameList = [];
        if(localStorage.getItem(storageKey)){
            nameList = localStorage.getItem(storageKey).split(",");
        }


        for(let i = 0; i < nameList.length; i++){
            $rankList.append(`<div class="item">${nameList[i]}<div>`);
        }

        localStorage.setItem("gameTimes", gameTimes);
    }


</script>

<script>
    const viewX = 1700;
    const viewY = 1700;
    const borderWidth = 2400;
    const borderHeight = 1700;
    const wallWidth = 40;
    const paddingTop = 80;
    const ballSize = 45;

    const ballsTexture = [ './static/img/ball2Texture.png', './static/img/ball3Texture.png'];
    const ballsColor = ['#fcff00', "#fcff00"];
    const stickTexture = './static/img/stickTexture.png';
    const slopeTexture = './static/img/slopeTexture.png';
    const middleTexture = './static/img/middleTexture.png';
    const boxWidthTexture = './static/img/boxWidthTexture.png';
    const boxHeightTexture = './static/img/boxHeightTexture.png';
    const trackObstructTexture = './static/img/trackObstructTexture.png';

    const Engine = Matter.Engine,
        Render = Matter.Render,
        Runner = Matter.Runner,
        Body = Matter.Body,
        Events = Matter.Events,
        Composite = Matter.Composite,
        Composites = Matter.Composites,
        Common = Matter.Common,
        Constraint = Matter.Constraint,
        MouseConstraint = Matter.MouseConstraint,
        Mouse = Matter.Mouse,
        World = Matter.World,
        Vertices = Matter.Vertices,
        Bodies = Matter.Bodies;

    let engine = null;
    let render = null;
    let runner = null;
    let world = null;

    (function () {
        engine = Engine.create({});
        world = engine.world;

        render = Render.create({
            element: document.getElementById("game-box"),
            engine: engine,
            options: {
                width: 1000,
                height: 700,
                showAngleIndicator: false,
                wireframes: false,
                background: "#00000000",//backgroundTexture,
            }
        });

        Render.run(render);

        runner = Runner.create();
        Runner.run(runner, engine);

        Render.lookAt(render, {
            min: {x: 0, y: 0},
            max: {x: viewX, y: viewY}
        });
    })();

    (function () {
        // 添加鼠标控制
        // const mouse = Mouse.create(render.canvas),
        //     mouseConstraint = MouseConstraint.create(engine, {
        //         mouse: mouse,
        //         constraint: {
        //             stiffness: 0.2,
        //             render: {
        //                 visible: false
        //             }
        //         }
        //     });
        //
        // World.add(world, mouseConstraint);
        // render.mouse = mouse;
    })();



    //当前选中的人
    let currentPeople = [];

    let centerBottom = null;
    let trackLeft = null;
    let stick = null;
    let balls = null;

    let startRotate = true;
    let startExtract = false;
    let canIClickBlankSpace = true;

    let selectPeopleNumber = 10;



    (function () {
        // 添加整体边框
        World.add(world, [
            Bodies.rectangle(viewX / 2, 0, borderWidth, wallWidth, {
                isStatic: true,
                render: {
                    fillStyle: "rgba(113, 135, 147, 0)",
                }
            }),
            Bodies.rectangle(viewX / 2, borderHeight, borderWidth * 2, wallWidth / 2, {
                isStatic: true,
                angle: 0,
                render: {
                    fillStyle: "rgba(113, 135, 147, 0.70)",
                }
            }),
            Bodies.rectangle((viewX + borderWidth) / 2, viewY / 2, wallWidth, borderHeight, {
                isStatic: true,
                render: {
                    fillStyle: "rgba(113, 135, 147, 0)",
                }
            }),
            Bodies.rectangle((viewX - borderWidth) / 2, viewY / 2, wallWidth, borderHeight, {
                isStatic: true,
                render: {
                    fillStyle: "rgba(113, 135, 147, 0)",
                }
            })
        ]);

        //  盒子底部挡板
        const leftBottom = Bodies.rectangle(530, 970, 420, wallWidth, {
            isStatic: true,
            angle: Math.PI * 0.1,
            render: {
                sprite: {
                    texture: slopeTexture,
                }
            }
        });

        const rightBottom = Bodies.rectangle(1170, 970, 420, wallWidth, {
            isStatic: true,
            angle: -Math.PI * 0.1,
            render: {
                sprite: {
                    texture: slopeTexture,
                }
            }
        });

        centerBottom = Bodies.rectangle(850, 1030, 320, wallWidth, {
            isStatic: true,
            render: {
                sprite: {
                    texture: middleTexture,
                }
            }
        });

        //  抽奖盒子
        World.add(world, [
            Bodies.rectangle(850, paddingTop, 1040, wallWidth, {
                isStatic: true,
                render: {
                    sprite: {
                        texture: boxWidthTexture,
                    }
                }
            }),
            Bodies.rectangle(1350, 495, wallWidth, 870, {
                isStatic: true,
                render: {
                    sprite: {
                        texture: boxHeightTexture,
                    }
                }
            }),
            //底部挡板换成两个挡板
            leftBottom,
            rightBottom,
            centerBottom,
            Bodies.rectangle(350, 495, wallWidth, 870, {
                isStatic: true,
                render: {
                    sprite: {
                        texture: boxHeightTexture,
                    }
                }
            })
        ]);

        //添加收球轨道
        let track = Bodies.rectangle(610, 1250, 1040, wallWidth, {
            isStatic: true,
            angle: -Math.PI * 0.03,
            render: {
                sprite: {
                    texture: boxWidthTexture,
                }
            }
        });

        trackLeft = Bodies.rectangle(110, 1200, wallWidth, 240, {
            isStatic: true,
            render: {
                sprite: {
                    texture: trackObstructTexture,
                }
            }
        });

        World.add(world, [
            track,
            trackLeft,
        ]);

        //  抽奖盒子旋转的棍子
        stick = Bodies.rectangle(850, 580, 770, wallWidth, {
            isStatic: true,
            render: {
                sprite: {
                    texture: stickTexture,
                }
            }
        });

        World.add(world, stick);

        let rotateAngle = 0;
        Events.on(engine, 'beforeUpdate', (event) => {
            //  转动抽奖棍子
            if (startRotate) {
                rotateAngle += 0.02;
                if (rotateAngle >= 2) {
                    rotateAngle = 0;
                }

                Body.setAngle(stick, Math.PI * rotateAngle)
            } else {
                //Body.setAngle(stick, Math.PI * 0.1)
            }

            if (startExtract) {
                for (let index in balls.bodies) {

                    let body = balls.bodies[index];

                    if (body.position.y > 1030) {
                        if (!currentPeople.includes(index)) {
                            currentPeople.push(index);
                            //添加到对应的人名单中
                            $GAME.updateRank(index)
                            --selectPeopleNumber;
                        }

                        if (selectPeopleNumber <= 0) {
                            $GAME.stopExtract();

                            setTimeout(() => {
                                //console.log(balls.bodies.length)
                                for (let index in balls.bodies) {
                                    let body = balls.bodies[index];
                                    if (body.position.y > 1020) {
                                        if (!currentPeople.includes(index)) {
                                            console.log("------放回去-------", index, people[index]);
                                            Matter.Body.setPosition(body, {x: 800, y: 250});
                                        }
                                    }
                                }

                                for (let index of currentPeople) {
                                    let ball = balls.bodies[index]

                                    if (ball.position.y < 1030) {
                                        console.log("------放出来-------", index, people[index]);
                                        Matter.Body.setPosition(ball, {x: viewX / 2, y: 1060});
                                    }
                                }
                            }, 500);

                            break;
                        }
                    }
                }
            }

        });
    })();

    const $GAME = {
        startRotate: () => {
            startRotate = true;
        },

        stopRotate: () => {
            startRotate = false;
        },

        startExtract: () => {
            if (gameStep === 1) {
                $rankLabel.html("三等奖");
                $rankList.html("");
            } else if (gameStep === 4) {
                $rankLabel.html("二等奖");
                $rankList.html("");
            } else if (gameStep === 8) {
                $rankLabel.html("一等奖");
                $rankList.html("");
            } else if (gameStep === 9) {
                $rankLabel.html("特等奖");
                $rankList.html("");
            }

            startExtract = true;
            Matter.Body.setAngle(centerBottom, -Math.PI * 0.2);
            Matter.Body.setPosition(centerBottom, {x: 880, y: 1110});
            //$GAME.stopRotate();

            Matter.Body.setPosition(trackLeft, {
                x: 110,
                y: 1200
            });
            Body.setAngle(trackLeft, 0);

            //将底部小球全部移动到一侧
            for (let index in balls.bodies) {
                let body = balls.bodies[index];
                if (body.position.x < 300 && body.position.y > 1200) {
                    Matter.Body.setPosition(body, {x: 1500, y: 1200});
                }
            }
        },

        stopExtract: () => {
            startExtract = false;
            Matter.Body.setAngle(centerBottom, 0);
            Matter.Body.setPosition(centerBottom, {x: 850, y: 1030});

            $GAME.startRotate();

            canIClickBlankSpace = false;
            setTimeout(() => {
                Body.setAngle(trackLeft, -Math.PI * .5);
                Matter.Body.setPosition(trackLeft, {x: 10, y: 1100});

                setTimeout(() => {
                    canIClickBlankSpace = true;
                    //TODO 10秒后可以再次摇奖
                }, 10000)
                //TODO 5秒后打开挡板
            }, 5000)
        },

        refreshBall: () => {
            let index = ballsTexture.length;
            let load = () => {
                index--;
                if (index === 0) {
                    let index = 0;
                    let height = parseInt(people.length / 10) + 1;
                    //加入抽奖人小球
                    balls = Composites.stack(390, 120, 10, height, 0, 0, (x, y) => {

                        let id = index++;

                        if (id > people.length - 1) {
                            return;
                        }

                        let image = new Image();
                        image.src = ballsTexture[index % ballsTexture.length];
                        let balltext = document.createElement("canvas");
                        balltext.width = ballSize * 2;
                        balltext.height = ballSize * 2;
                        balltext.getContext("2d").drawImage(image, 0, 0, 40, 40, 0, 0, ballSize * 2, ballSize * 2);
                        balltext.getContext("2d").fillStyle = ballsColor[index % ballsColor.length];
                        balltext.getContext("2d").font = "bold 25px 微软雅黑"; //bold
                        if (people[id].length === 3) {
                            balltext.getContext("2d").fillText(people[id], 10, 50);
                        } else {
                            balltext.getContext("2d").fillText(people[id], 20, 50);
                        }

                        balltext.getContext("2d").textAlign = "center";

                        return Bodies.circle(x, y, ballSize, {
                            density: 100,
                            frictionAir: 0.000001,
                            restitution: 0,
                            friction: 0.000001,
                            render: {
                                sprite: {
                                    texture: balltext.toDataURL("image/png"),
                                }
                            }
                        });
                    });

                    World.add(world, balls);
                }
            };

            for (let i = 0; i < ballsTexture.length; i++) {
                let image = new Image();
                image.src = ballsTexture[i];
                image.onload = load;
            }

        },

        updateRank: (index) => {
            let name = people[index];
            $rankList.append(`<div class="item">${name}<div>`);


            let type = "";
            if (gameStep <= 3) {
                type = "three";
            } else if (gameStep <= 7) {
                type = "two";
            } else if (gameStep === 8) {
                type = "one";
            } else if (gameStep <= 10) {
                type = "super";
            }

            let storageKey = `${gameTimes}_${timeStamp}_${type}`;

            let array = localStorage.getItem(storageKey);
            if (array) {
                array += `,${name}`;
            } else {
                array = `${name}`
            }

            localStorage.setItem(storageKey, array);

            if(gameStep === 10){
                localStorage.setItem("gameTimes", ++gameTimes);
            }
        }
    };

    $GAME.refreshBall();

    document.onkeyup = e => {
        e = e || event;
        let currKey = e.keyCode || e.which || e.charCode;
        if (currKey === 32) {

            if (startExtract || !canIClickBlankSpace) {
                // console.log("阻止")
                return;
            }

            // console.log("穿过了", startExtract, canIClickBlankSpace);

            switch (++gameStep) {
                //三等奖 10人 三轮
                case 1:
                    selectPeopleNumber = 10;
                    $GAME.startExtract();
                    break;
                case 2:
                    selectPeopleNumber = 10;
                    $GAME.startExtract();
                    break;
                case 3:
                    selectPeopleNumber = 10;
                    $GAME.startExtract();
                    break;

                //二等奖 5人 四轮
                case 4:
                    selectPeopleNumber = 5;
                    $GAME.startExtract();
                    break;
                case 5:
                    selectPeopleNumber = 5;
                    $GAME.startExtract();
                    break;
                case 6:
                    selectPeopleNumber = 5;
                    $GAME.startExtract();
                    break;
                case 7:
                    selectPeopleNumber = 5;
                    $GAME.startExtract();
                    break;

                //一等奖 5人 一轮
                case 8:
                    selectPeopleNumber = 5;
                    $GAME.startExtract();
                    break;

                //特等奖 2人 二轮
                case 9:
                    selectPeopleNumber = 1;
                    $GAME.startExtract();
                    break;
                case 10:
                    selectPeopleNumber = 1;
                    $GAME.startExtract();
                    break;
                default:
                    gameStep--;
                    break;
            }

            localStorage.setItem("gameStep", gameStep);

        }
    };
</script>
